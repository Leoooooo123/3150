<!DOCTYPE HTML>
<html lang="en" >
    
    <head>
        
        <meta charset="UTF-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge" />
        <title>Pipe with fork | CSCI3150 - IPC-Pipe</title>
        <meta content="text/html; charset=utf-8" http-equiv="Content-Type">
        <meta name="description" content="">
        <meta name="generator" content="GitBook 2.6.7">
        
        
        <meta name="HandheldFriendly" content="true"/>
        <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no">
        <meta name="apple-mobile-web-app-capable" content="yes">
        <meta name="apple-mobile-web-app-status-bar-style" content="black">
        <link rel="apple-touch-icon-precomposed" sizes="152x152" href="gitbook/images/apple-touch-icon-precomposed-152.png">
        <link rel="shortcut icon" href="gitbook/images/favicon.ico" type="image/x-icon">
        
    <link rel="stylesheet" href="gitbook/style.css">
    
        
        <link rel="stylesheet" href="gitbook/plugins/gitbook-plugin-quiz/style.css">
        
    
        
        <link rel="stylesheet" href="gitbook/plugins/gitbook-plugin-highlight/website.css">
        
    
        
        <link rel="stylesheet" href="gitbook/plugins/gitbook-plugin-search/search.css">
        
    
        
        <link rel="stylesheet" href="gitbook/plugins/gitbook-plugin-fontsettings/website.css">
        
    
    

        
    
    
    <link rel="next" href="./exercise-1.html" />
    
    
    <link rel="prev" href="./pipe-creation.html" />
    

        
    </head>
    <body>
        
        
    <div class="book"
        data-level="2.2"
        data-chapter-title="Pipe with fork"
        data-filepath="pipe-fork.md"
        data-basepath="."
        data-revision="Thu Oct 06 2016 12:56:14 GMT+0800 (HKT)"
        data-innerlanguage="">
    

<div class="book-summary">
    <nav role="navigation">
        <ul class="summary">
            
            
            
            

            

            
    
        <li class="chapter " data-level="0" data-path="index.html">
            
                
                    <a href="./index.html">
                
                        <i class="fa fa-check"></i>
                        
                        Goal of this lab
                    </a>
            
            
        </li>
    
        <li class="chapter " data-level="1" >
            
            <span><b>1.</b> Knowing about pipe</span>
            
            
            <ul class="articles">
                
    
        <li class="chapter " data-level="1.1" data-path="man-pipe.html">
            
                
                    <a href="./man-pipe.html">
                
                        <i class="fa fa-check"></i>
                        
                            <b>1.1.</b>
                        
                        Pipe overview
                    </a>
            
            
        </li>
    
        <li class="chapter " data-level="1.2" data-path="system-pipe.html">
            
                
                    <a href="./system-pipe.html">
                
                        <i class="fa fa-check"></i>
                        
                            <b>1.2.</b>
                        
                        System call pipe
                    </a>
            
            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="2" >
            
            <span><b>2.</b> Learn to use pipe</span>
            
            
            <ul class="articles">
                
    
        <li class="chapter " data-level="2.1" data-path="pipe-creation.html">
            
                
                    <a href="./pipe-creation.html">
                
                        <i class="fa fa-check"></i>
                        
                            <b>2.1.</b>
                        
                        Pipe creation
                    </a>
            
            
        </li>
    
        <li class="chapter active" data-level="2.2" data-path="pipe-fork.html">
            
                
                    <a href="./pipe-fork.html">
                
                        <i class="fa fa-check"></i>
                        
                            <b>2.2.</b>
                        
                        Pipe with fork
                    </a>
            
            
        </li>
    
        <li class="chapter " data-level="2.3" data-path="exercise-1.html">
            
                
                    <a href="./exercise-1.html">
                
                        <i class="fa fa-check"></i>
                        
                            <b>2.3.</b>
                        
                        Exercise
                    </a>
            
            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="3" >
            
            <span><b>3.</b> Pipe in shell</span>
            
            
            <ul class="articles">
                
    
        <li class="chapter " data-level="3.1" data-path="pipe-shell.html">
            
                
                    <a href="./pipe-shell.html">
                
                        <i class="fa fa-check"></i>
                        
                            <b>3.1.</b>
                        
                        Implement ls | less in C
                    </a>
            
            
        </li>
    
        <li class="chapter " data-level="3.2" data-path="exercise-2.html">
            
                
                    <a href="./exercise-2.html">
                
                        <i class="fa fa-check"></i>
                        
                            <b>3.2.</b>
                        
                        Exercise
                    </a>
            
            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="4" data-path="reference.html">
            
                
                    <a href="./reference.html">
                
                        <i class="fa fa-check"></i>
                        
                            <b>4.</b>
                        
                        4. Reference
                    </a>
            
            
        </li>
    


            
            <li class="divider"></li>
            <li>
                <a href="https://www.gitbook.com" target="blank" class="gitbook-link">
                    Published with GitBook
                </a>
            </li>
            
        </ul>
    </nav>
</div>

    <div class="book-body">
        <div class="body-inner">
            <div class="book-header" role="navigation">
    <!-- Actions Left -->
    

    <!-- Title -->
    <h1>
        <i class="fa fa-circle-o-notch fa-spin"></i>
        <a href="./" >CSCI3150 - IPC-Pipe</a>
    </h1>
</div>

            <div class="page-wrapper" tabindex="-1" role="main">
                <div class="page-inner">
                
                
                    <section class="normal" id="section-">
                    
                        <h2 id="pipe-with-fork">Pipe with fork</h2>
<hr>
<p><code>pipe1.c</code> shows you the basic operation on pipe. But it is not very useful for a single process to use a pipe to talk to itself. In typical use, a process creates a pipe just before it forks one or more child processes. The pipe is then used for communication either between the parent or child processes, or between two sibling processes <strong>(A2)</strong>. <code>pipe2.c</code> and <code>pipe3.c</code> show you how pipe works between related process.</p>
<p>In <a href="code/pipe2.c"><code>pipe2.c</code></a>, parent write &quot;CSCI3150&quot; to the pipe, child read from the pipe 1 byte at a time until the pipe is empty.</p>
<pre><code class="lang-c"><span class="hljs-comment">/* pipe2.c */</span>
<span class="hljs-preprocessor">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdio.h&gt;</span></span>
<span class="hljs-preprocessor">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdlib.h&gt;</span></span>
<span class="hljs-preprocessor">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;unistd.h&gt;</span></span>
<span class="hljs-preprocessor">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;string.h&gt;</span></span>
<span class="hljs-function"><span class="hljs-keyword">int</span> <span class="hljs-title">main</span><span class="hljs-params">(<span class="hljs-keyword">int</span> argc, <span class="hljs-keyword">char</span>* argv[])</span>
</span>{
    <span class="hljs-keyword">int</span> pipefds[<span class="hljs-number">2</span>];
      <span class="hljs-keyword">pid_t</span> pid;
    <span class="hljs-keyword">char</span> buf[<span class="hljs-number">30</span>];
    <span class="hljs-comment">//create pipe</span>
    <span class="hljs-keyword">if</span>(pipe(pipefds) == -<span class="hljs-number">1</span>){
        perror(<span class="hljs-string">&quot;pipe&quot;</span>);
        <span class="hljs-built_in">exit</span>(EXIT_FAILURE);
    }
      <span class="hljs-built_in">memset</span>(buf,<span class="hljs-number">0</span>,<span class="hljs-number">30</span>);
      pid = fork();
    <span class="hljs-keyword">if</span> (pid &gt; <span class="hljs-number">0</span>) {
      <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot; PARENT write in pipe\n&quot;</span>);
    <span class="hljs-comment">//parent close the read end</span>
          close(pipefds[<span class="hljs-number">0</span>]);
    <span class="hljs-comment">//parent write in the pipe write end                 </span>
      write(pipefds[<span class="hljs-number">1</span>], <span class="hljs-string">&quot;CSCI3150&quot;</span>, <span class="hljs-number">9</span>);
    <span class="hljs-comment">//after finishing writing, parent close the write end</span>
          close(pipefds[<span class="hljs-number">1</span>]);
    <span class="hljs-comment">//parent wait for child                </span>
      wait(<span class="hljs-literal">NULL</span>);                         
    }<span class="hljs-keyword">else</span> {
      <span class="hljs-comment">//child close the write end  </span>
      close(pipefds[<span class="hljs-number">1</span>]);   <span class="hljs-comment">//-----line *</span>
      <span class="hljs-comment">//child read from the pipe read end until the pipe is empty   </span>
      <span class="hljs-keyword">while</span>(read(pipefds[<span class="hljs-number">0</span>], buf, <span class="hljs-number">1</span>)==<span class="hljs-number">1</span>)   
        <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;CHILD read from pipe -- %s\n&quot;</span>, buf);
      <span class="hljs-comment">//after finishing reading, child close the read end</span>
      close(pipefds[<span class="hljs-number">0</span>]);
      <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;CHILD: EXITING!&quot;</span>);
      <span class="hljs-built_in">exit</span>(EXIT_SUCCESS);
    }
    <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;
}
</code></pre>
<p><img src="assets/pipe2.PNG" alt="">
<strong>Analysis:</strong> As you can see, the pipe works correctly. After fork(), pipe file descriptors are shared between the parent and child, as show in the picture below.</p>
<p><img src="assets/pipe_fork.PNG" alt=""></p>
<p>To ensure pipe work properly, you should: <strong>* Always be sure to close the end of pipe you aren&apos;t concerned with.</strong> That is, if the parent wants to receive data from the child, it should close pipefds[1], and the child should close pipefds[0]. When processes finish reading or writting, close related file descriptors. Otherwise, there will be undesired synchronization problems.</p>
<p><a href="code/pipe3.c"><code>pipe3.c</code></a> is almost the same with pipe2.c except line * is commented out. That means, child forget to close write end. What will happen?</p>
<pre><code class="lang-c"><span class="hljs-comment">/* pipe3.c */</span>
<span class="hljs-preprocessor">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdio.h&gt;</span></span>
<span class="hljs-preprocessor">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdlib.h&gt;</span></span>
<span class="hljs-preprocessor">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;unistd.h&gt;</span></span>
<span class="hljs-preprocessor">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;string.h&gt;</span></span>
<span class="hljs-function"><span class="hljs-keyword">int</span> <span class="hljs-title">main</span><span class="hljs-params">(<span class="hljs-keyword">int</span> argc, <span class="hljs-keyword">char</span>* argv[])</span>
</span>{
    <span class="hljs-keyword">int</span> pipefds[<span class="hljs-number">2</span>];
      <span class="hljs-keyword">pid_t</span> pid;
    <span class="hljs-keyword">char</span> buf[<span class="hljs-number">30</span>];
    <span class="hljs-comment">//create pipe</span>
    <span class="hljs-keyword">if</span>(pipe(pipefds) == -<span class="hljs-number">1</span>){
        perror(<span class="hljs-string">&quot;pipe&quot;</span>);
        <span class="hljs-built_in">exit</span>(EXIT_FAILURE);
    }
      <span class="hljs-built_in">memset</span>(buf,<span class="hljs-number">0</span>,<span class="hljs-number">30</span>);
      pid = fork();
    <span class="hljs-keyword">if</span> (pid &gt; <span class="hljs-number">0</span>) {
      <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot; PARENT write in pipe\n&quot;</span>);
    <span class="hljs-comment">//parent close the read end</span>
          close(pipefds[<span class="hljs-number">0</span>]);
    <span class="hljs-comment">//parent write in the pipe write end                 </span>
      write(pipefds[<span class="hljs-number">1</span>], <span class="hljs-string">&quot;CSCI3150&quot;</span>, <span class="hljs-number">9</span>);
    <span class="hljs-comment">//after finishing writing, parent close the write end</span>
          close(pipefds[<span class="hljs-number">1</span>]);
    <span class="hljs-comment">//parent wait for child                </span>
      wait(<span class="hljs-literal">NULL</span>);                         
    }<span class="hljs-keyword">else</span> {  
      <span class="hljs-comment">//child read from the pipe read end until the pipe is empty   </span>
      <span class="hljs-keyword">while</span>(read(pipefds[<span class="hljs-number">0</span>], buf, <span class="hljs-number">1</span>)==<span class="hljs-number">1</span>)   
        <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;CHILD read from pipe -- %s\n&quot;</span>, buf);
      <span class="hljs-comment">//after finishing reading, child close the read end</span>
      close(pipefds[<span class="hljs-number">0</span>]);
      <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;CHILD: EXITING!&quot;</span>);
      <span class="hljs-built_in">exit</span>(EXIT_SUCCESS);
    }
    <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;
}
</code></pre>
<p><img src="assets/pipe3.PNG" alt="">
<strong>Analysis:</strong> We can see that the child process doesn&apos;t exit. What&apos;s going on? Note that the child process still has pipefds[1] open. The system will assume that a write could occur while any process has the write end open, even if the only such process is the one that is currently trying to read from the pipe, and the system will not report EOF <strong>(A4)</strong>, therefore. Thus child is waiting to read from pipefds[0], and the operating system doesn&apos;t know that no process will be writing to pipdfds[1]. So <strong>the child process blocks until data arrives to be read(A3)</strong></p>

                    
                    </section>
                
                
                </div>
            </div>
        </div>

        
        <a href="./pipe-creation.html" class="navigation navigation-prev " aria-label="Previous page: Pipe creation"><i class="fa fa-angle-left"></i></a>
        
        
        <a href="./exercise-1.html" class="navigation navigation-next " aria-label="Next page: Exercise"><i class="fa fa-angle-right"></i></a>
        
    </div>
</div>

        
<script src="gitbook/app.js"></script>

    
    <script src="gitbook/plugins/gitbook-plugin-quiz/script.js"></script>
    

    
    <script src="gitbook/plugins/gitbook-plugin-search/lunr.min.js"></script>
    

    
    <script src="gitbook/plugins/gitbook-plugin-search/search.js"></script>
    

    
    <script src="gitbook/plugins/gitbook-plugin-sharing/buttons.js"></script>
    

    
    <script src="gitbook/plugins/gitbook-plugin-fontsettings/buttons.js"></script>
    

<script>
require(["gitbook"], function(gitbook) {
    var config = {"quiz":{},"highlight":{},"search":{"maxIndexSize":1000000},"sharing":{"facebook":true,"twitter":true,"google":false,"weibo":false,"instapaper":false,"vk":false,"all":["facebook","google","twitter","weibo","instapaper"]},"fontsettings":{"theme":"white","family":"sans","size":2}};
    gitbook.start(config);
});
</script>

        
    </body>
    
</html>
